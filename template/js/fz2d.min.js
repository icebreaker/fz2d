var Fz2D,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1},__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};Fz2D=function(){function Fz2D(){}Fz2D.VERSION="0.0.1";Fz2D.NONE=0;Fz2D.TOP=1<<1;Fz2D.LEFT=1<<2;Fz2D.RIGHT=1<<3;Fz2D.BOTTOM=1<<4;Fz2D.FG="#FFFFFF";Fz2D.BG="#000000";Fz2D.SELECTOR="#canvas";Fz2D.PATH="assets";Fz2D.query=function(){var hash,k,kk,q,query,v,vv,_i,_len,_ref,_ref1;hash={};query=window.location.href.split("?").pop();_ref=query.split("&");for(_i=0,_len=_ref.length;_i<_len;_i++){q=_ref[_i];_ref1=q.split("="),k=_ref1[0],v=_ref1[1];kk=unescape(k);vv=unescape(v);if(/^\d+$/.test(vv)){vv=parseInt(vv)}else if(/^true|false$/i.test(vv)){vv=JSON.parse(vv);if(!(kk in Fz2D)){if(vv){Fz2D[kk]=kk}}}hash[kk]=vv}return hash}();Fz2D.url=function(){return window.location.href.split("?")[0]}();Fz2D.https=function(){if(window.location.protocol==="https:"){return"https"}else{return null}}();Fz2D.development=function(){if(Fz2D.debug!=null){return"development"}if(/localhost|127.0.0.1/i.test(window.location.hostname)){return"development"}this.production="production";return null}();Fz2D.clamp=function(d,min,max){return Math.min(Math.max(d,min),max)};Fz2D.step=function(t,d,min,max){var dt;dt=t/d;return Fz2D.clamp(max*dt+min*(1-dt),Math.min(min,max),Math.max(min,max))};Fz2D.dist=function(o1,o2){var dx,dy,x1,x2,y1,y2;x1=o1.x+o1.bounds.x;y1=o1.y+o1.bounds.y;x2=o2.x+o2.bounds.x;y2=o2.y+o2.bounds.y;dx=x2-x1;dy=y2-y1;return Math.sqrt(dx*dx+dy*dy)};Fz2D.distSqr=function(o1,o2){var dx,dy,x1,x2,y1,y2;x1=o1.x+o1.bounds.x;y1=o1.y+o1.bounds.y;x2=o2.x+o2.bounds.x;y2=o2.y+o2.bounds.y;dx=x2-x1;dy=y2-y1;return dx*dx+dy*dy};Fz2D.getCollisionSide=function(o1,o2){var result,x1,x2,y1,y2;x1=o1.x+o1.bounds.cx;y1=o1.y+o1.bounds.cy;x2=o2.x+o2.bounds.cx;y2=o2.y+o2.bounds.cy;result=Fz2D.NONE;if(y1>y2){result|=Fz2D.BOTTOM}else{result|=Fz2D.TOP}if(x1>x2){result|=Fz2D.RIGHT}else{result|=Fz2D.LEFT}return result};Fz2D.collide=function(o1,o2,callback){var collide,o3,x1,x2,y1,y2,_i,_j,_len,_len1,_ref,_ref1;if(!(o1.exists&&o1.solid&&o2.exists&&o2.solid&&o1!==o2)){return false}if(o1._objects&&o2._objects){collide=false;_ref=o1._objects;for(_i=0,_len=_ref.length;_i<_len;_i++){o3=_ref[_i];if(Fz2D.collide(o3,o2,callback)){collide=true}}return collide}if(o1._objects){o3=o1;o1=o2;o2=o3}if(o2._objects){if(!o2.bounds.isNull()&&!Fz2D.overlap(o1,o2)){return false}collide=false;_ref1=o2._objects;for(_j=0,_len1=_ref1.length;_j<_len1;_j++){o3=_ref1[_j];if(Fz2D.collide(o1,o3,callback)){collide=true}}return collide}x1=o1.x+o1.bounds.x;y1=o1.y+o1.bounds.y;x2=o2.x+o2.bounds.x;y2=o2.y+o2.bounds.y;if(!(x1>x2+o2.bounds.w||y1>y2+o2.bounds.h||x1+o1.bounds.w<x2||y1+o1.bounds.h<y2)){callback(o1,o2);return true}else{return false}};Fz2D.contains=function(o,p){var x,y;x=o.x+o.bounds.x;y=o.y+o.bounds.y;return p.x>=x&&p.x<=x+o.bounds.w&&p.y>=y&&p.y<=y+o.bounds.h};Fz2D.overlap=function(o1,o2){var x1,x2,y1,y2;x1=o1.x+o1.bounds.x;y1=o1.y+o1.bounds.y;x2=o2.x+o2.bounds.x;y2=o2.y+o2.bounds.y;return!(x1>x2+o2.bounds.w||y1>y2+o2.bounds.h||x1+o1.bounds.w<x2||y1+o1.bounds.h<y2)};Fz2D.swap=function(a,b){var tmp;tmp=a;a=b;b=a;return[a,b]};Fz2D.toRGB=function(color){var c;c=parseInt(color.slice(1),16);return{r:(c>>16&255)/255,g:(c>>8&255)/255,b:(c&255)/255}};Fz2D.getEl=function(){if(document.querySelector!=null){return function(selector){return document.querySelector(selector)}}else{return function(selector){return document.getElementById(selector.slice(1))}}}();Fz2D.createEl=function(type,attrs,styles){var el,k,v;if(attrs==null){attrs={}}if(styles==null){styles={}}el=document.createElement(type);for(k in attrs){v=attrs[k];el[k]=v}for(k in styles){v=styles[k];el.style[k]=v}return el};Fz2D.appendEl=function(el,parent){if(parent==null){parent=document.body}parent.appendChild(el);return el};Fz2D.setStyleEl=function(el,styles){var k,v;if(styles==null){styles={}}for(k in styles){v=styles[k];el.style[k]=v}return el};Fz2D.getJSON=function(url,callback){var req;req=new XMLHttpRequest;req.open("GET",url,true);req.setRequestHeader("Content-type","application/json");req.onreadystatechange=function(){if(req.readyState===4){if(req.status===200){return callback(window.JSON.parse(req.responseText),req.status)}else{return callback(req.responseText,req.status)}}};return req.send(null)};Fz2D.Plugins={};Fz2D.Gui={};return Fz2D}();if(typeof global!=="undefined"&&global!==null&&typeof global==="object"){Fz2D.__path=require("path");Fz2D.require=function(file){return require(Fz2D.__path.join(__dirname,file))};global.Fz2D=Fz2D}if(window.requestAnimationFrame==null){window.requestAnimationFrame=function(window){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback,element){return window.setTimeout(callback,1e3/60)}}(window)}if(window.console==null){window.console=function(window){return{log:function(text){}}}(window)}if(window.localStorage==null){window.localStorage=function(window){var LocalStorageImpl;LocalStorageImpl=function(){function LocalStorageImpl(){this.data={}}LocalStorageImpl.prototype.setItem=function(name,value){return this.data[name]=data};LocalStorageImpl.prototype.getItem=function(name){return this.data[name]};LocalStorageImpl.prototype.removeItem=function(name){return this.data[name]=null};return LocalStorageImpl}();return new LocalStorageImpl}(window)}if(window.performance==null){window.performance={}}if(window.performance.memory==null){window.performance.memory={usedJSHeapSize:0}}Fz2D.Input=function(){function Input(element,x,y){if(x==null){x=0}if(y==null){y=0}this.keys=new Fz2D.Input.Keyboard;this.mouse=new Fz2D.Input.Mouse(element,x,y)}Input.prototype.update=function(){this.keys.update();return this.mouse.update()};return Input}();Fz2D.Input.Keyboard=function(){function Keyboard(){this.update();if(window.event){window.onkeydown=function(_this){return function(e){return _this[e.which]=_this.pressed[e.which]=true}}(this);window.onkeyup=function(_this){return function(e){return _this[e.which]=_this.pressed[e.which]=false}}(this)}else{window.onkeydown=function(_this){return function(e){return _this[e.keyCode]=_this.pressed[e.keyCode]=true}}(this);window.onkeyup=function(_this){return function(e){return _this[e.keyCode]=_this.pressed[e.keyCode]=false}}(this)}}Keyboard.prototype.update=function(){return this.pressed={}};return Keyboard}();Fz2D.Input.Keyboard.Key=function(){var c,_i,_ref,_ref1;function Key(){}for(c=_i=_ref="A".charCodeAt(0),_ref1="Z".charCodeAt(0);_ref<=_ref1?_i<=_ref1:_i>=_ref1;c=_ref<=_ref1?++_i:--_i){Key[String.fromCharCode(c)]=c}Key.ENTER=13;Key.ESC=27;Key.SPACE=32;Key.LEFT=37;Key.UP=38;Key.RIGHT=39;Key.DOWN=40;return Key}();Fz2D.Input.Mouse=function(){function Mouse(element,x,y){this.x=x!=null?x:0;this.y=y!=null?y:0;this.position=new Fz2D.Point(this.x,this.y);this.update();element.onmousedown=function(_this){return function(e){_this[e.button]=_this.pressed[e.button]=true;_this.released[e.button]=false;return false}}(this);element.onmouseup=function(_this){return function(e){_this[e.button]=_this.pressed[e.button]=false;_this.released[e.button]=true;return false}}(this);if(/firefox/i.test(navigator.userAgent)){element.onmousemove=function(_this){return function(e){if(e.layerX||e.layerX===0){_this.dx=e.layerX-_this.x;_this.dy=e.layerY-_this.y;_this.position.x=_this.x=e.layerX;return _this.position.y=_this.y=e.layerY}}}(this)}else{element.onmousemove=function(_this){return function(e){if(e.offsetX||e.offsetX===0){_this.dx=e.offsetX-_this.x;_this.dy=e.offsetY-_this.y;_this.position.x=_this.x=e.offsetX;return _this.position.y=_this.y=e.offsetY}}}(this)}element.oncontextmenu=function(e){return false};this._element=element}Mouse.prototype.show=function(){return this._element.style.cursor="hand"};Mouse.prototype.hide=function(){return this._element.style.cursor="none"};Mouse.prototype.update=function(){this.dx=this.dy=0;this.pressed={};return this.released={}};return Mouse}();Fz2D.Input.Mouse.Button=function(){function Button(){}Button.LEFT=0;Button.MIDDLE=1;Button.RIGHT=2;return Button}();Fz2D.Loader=function(){Loader.Loaders={};function Loader(game){var k,loader,_loader,_ref;this.loaded=0;this.total=0;this.pct=0;this.visible=this.alive=this.exists=true;this.w=256;this.h=24;this.x=game.w-this.w>>1;this.y=game.h-this.h>>1;this._outer=new Fz2D.Texture(game.fg,this.w,this.h);this._inner=new Fz2D.Texture(game.bg,this.w,this.h);this._files={};this._loaders={};_ref=Fz2D.Loader.Loaders;for(k in _ref){loader=_ref[k];_loader=new loader(game.path);_loader.onload=function(_this){return function(){if(++_this.loaded>=_this.total){_this.onload()}return console.log("Loaded: "+(_this.pct*100|0)+"%")}}(this);console.log("Registered loader "+k+" for the `"+_loader.extension+"` extension.");this._loaders[_loader.extension]=_loader}}Loader.prototype.onload=function(){};Loader.prototype.load=function(path){var extension,loader;if(this._files[path]!=null){return this._files[path]}extension=path.split(".").pop();if(extension!=null){loader=this._loaders[extension];if(loader!=null){this.total++;return this._files[path]=loader.load(path)}else{console.log("No loader registered for this `"+extension+"` extension. Sorry :(");return null}}else{console.log("Ignoring `"+path+"` because it has no extension. :(");return null}};Loader.prototype.draw=function(ctx){ctx.draw(this._outer,0,0,this.w,this.h,this.x,this.y,this.w,this.h);ctx.draw(this._inner,0,0,this.w-4,this.h-4,this.x+2,this.y+2,this.w-4,this.h-4);return ctx.draw(this._outer,0,0,this.w-12,this.h-12,this.x+6,this.y+6,this.pct*(this.w-12),this.h-12)};Loader.prototype.update=function(timer,input){return this.pct=this.loaded/this.total};Loader.prototype.isLoading=function(){return this.loaded<this.total};return Loader}();Fz2D.Loader.Base=function(){Base.prototype.extension=null;Base.prototype.path=null;function Base(path){this._path=""+path+"/"+this.path}Base.prototype.expand=function(path,extension){if(extension==null){extension=null}if(extension!=null){return""+this._path+"/"+path.slice(0,path.length-this.extension.length)+extension}else{return""+this._path+"/"+path}};Base.prototype.load=function(path){throw"load() must be implemented by each loader, and must call onload(asset)"};Base.prototype.onload=function(asset){};return Base}();Fz2D.Loader.Loaders.Audio=function(_super){__extends(Audio,_super);function Audio(){return Audio.__super__.constructor.apply(this,arguments)}Audio.prototype.extension="ogg";Audio.prototype.path="sounds";Audio.prototype.load=function(path){var audio;audio=new Fz2D.Audio;if(Fz2D.Audio.supported!=null){audio.onload=function(_this){return function(){return _this.onload(audio)}}(this);audio.load(this.expand(path,Fz2D.Audio.extension))}else{this.onload(audio)}return audio};return Audio}(Fz2D.Loader.Base);Fz2D.Loader.Loaders.JSON=function(_super){__extends(JSON,_super);function JSON(){return JSON.__super__.constructor.apply(this,arguments)}JSON.prototype.extension="json";JSON.prototype.path="json";JSON.prototype.load=function(path){var expanded_path,json;expanded_path=this.expand(path);json={};Fz2D.getJSON(expanded_path,function(_this){return function(resp,code){var k,v;if(code===200){console.log("Loaded json: "+Fz2D.url+expanded_path);for(k in resp){v=resp[k];json[k]=v}}else{console.log("Failed to load json: "+Fz2D.url+expanded_path)}return _this.onload(json)}}(this));return json};return JSON}(Fz2D.Loader.Base);Fz2D.Loader.Loaders.Texture=function(_super){__extends(Texture,_super);function Texture(){return Texture.__super__.constructor.apply(this,arguments)}Texture.prototype.extension="png";Texture.prototype.path="textures";Texture.prototype.load=function(path){var texture;texture=new Fz2D.Texture;texture.onload=function(_this){return function(){return _this.onload(texture)}}(this);texture.load(this.expand(path));return texture};return Texture}(Fz2D.Loader.Base);Fz2D.Loader.Loaders.TextureAtlas=function(_super){__extends(TextureAtlas,_super);TextureAtlas.prototype.extension="atlas";TextureAtlas.prototype.path="json";function TextureAtlas(path){TextureAtlas.__super__.constructor.apply(this,arguments);this._texture_atlases={};this._texture_loader=new Fz2D.Loader.Loaders.Texture(path);this._texture_loader.onload=function(_this){return function(texture){var k,texture_atlas,v,_ref;texture_atlas=_this._texture_atlases[texture.src];if(texture_atlas!=null&&texture_atlas.__regions!=null){texture_atlas.setTexture(texture);_ref=texture_atlas.__regions;for(k in _ref){v=_ref[k];texture_atlas.addTexture(k,v.x,v.y,v.w,v.h)}delete texture_atlas["__regions"];delete _this._texture_atlases[texture.src]}return _this.onload()}}(this)}TextureAtlas.prototype.load=function(path){var expanded_path,texture_atlas;expanded_path=this.expand(path);texture_atlas=new Fz2D.TextureAtlas;Fz2D.getJSON(expanded_path,function(_this){return function(resp,code){if(code===200){if(resp.src!=null&&resp.regions!=null){console.log("Loaded texture atlas: "+Fz2D.url+expanded_path);texture_atlas.__regions=resp.regions;_this._texture_atlases[_this._texture_loader.expand(resp.src)]=texture_atlas;return _this._texture_loader.load(resp.src)}else{console.log("Invalid texture atlas: "+Fz2D.url+expanded_path);return _this.onload()}}else{console.log("Failed to load texture atlas: "+Fz2D.url+expanded_path);return _this.onload()}}}(this));return texture_atlas};return TextureAtlas}(Fz2D.Loader.Base);Fz2D.Plugins.Console=function(){Console.supported=Fz2D.debug;Console.prototype.styles={backgroundColor:"rgba(0, 0, 0, 0.5)",width:window.innerWidth-60,height:"100px",padding:"8px",position:"absolute",bottom:0,right:0,margin:"20px",border:"2px solid #B00000",font:"18px Arial",color:"#B00000",overflow:"auto",zIndex:999};function Console(game){this._div=Fz2D.createEl("div",{},this.styles);Fz2D.appendEl(this._div);if(window.console==null){window.console={}}window.console.log=function(_this){return function(){var arg,div,text,_i,_len;text=[];for(_i=0,_len=arguments.length;_i<_len;_i++){arg=arguments[_i];if(typeof arg==="object"){text.push(JSON.stringify(arg,null," "))}else{text.push(arg)}}div=Fz2D.createEl("div");div.innerHTML=text.join(" ");_this._div.appendChild(div);return _this._div.scrollTop=_this._div.scrollHeight}}(this)}return Console}();Fz2D.Plugins.GitHub=function(){GitHub.supported=Fz2D.production||Fz2D.github;GitHub.prototype.colors={red:"aa0000",green:"007200",darkblue:"126121",orange:"ff7600",gray:"6d6d6d",white:"ffffff"};GitHub.prototype.positions=["left","right"];function GitHub(game){var config,_ref;if(game.github==null){return}config=game.github;if(!(config.color in this.colors)){config.color="red"}if(_ref=config.position,__indexOf.call(this.positions,_ref)<0){config.position="right"}this._createRibbon(config.username,config.repository,config.color,config.position)}GitHub.prototype._createRibbon=function(username,repository,color,position){var a,image;a=Fz2D.createEl("a",{href:"https://github.com/"+username+"/"+repository,target:"_blank"});image=new Image;image.alt="Fork me on GitHub";image.src="https://s3.amazonaws.com/github/ribbons/forkme_"+position+"_"+color+"_"+this.colors[color]+".png";Fz2D.setStyleEl(image,{position:"absolute",top:0,border:0,zIndex:999});if(position==="left"){Fz2D.setStyleEl(image,{left:0})}else{Fz2D.setStyleEl(image,{right:0})}Fz2D.appendEl(image,a);Fz2D.appendEl(a);return a};return GitHub}();Fz2D.Plugins.GoogleAnalytics=function(){GoogleAnalytics.supported=Fz2D.production;GoogleAnalytics.track=function(id,event){var ga,script;if(event==null){event=["_trackPageview"]}if(window._gaq){window._gaq.push(event);return}window._gaq=[];window._gaq.push(["_setAccount",id]);window._gaq.push(event);ga=Fz2D.createEl("script",{type:"text/javascript",async:true});if(Fz2D.https!=null){ga.src="https://ssl.google-analytics.com/ga.js"}else{ga.src="http://www.google-analytics.com/ga.js"}script=document.getElementsByTagName("script")[0];return script.parentNode.insertBefore(ga,script)};function GoogleAnalytics(game){if(game.ga!=null&&game.ga.id!=null){Fz2D.GoogleAnalytics.track(game.ga.id,game.ga.event)}}return GoogleAnalytics}();Fz2D.Plugins.Stats=function(){Stats.supported=Fz2D.stats;Stats.prototype.styles={backgroundColor:"rgba(0, 0, 0, 0.5)",padding:"8px",position:"absolute",left:0,top:0,margin:"20px",border:"2px solid #B00000",font:"28px Arial",color:"#B00000",zIndex:999};function Stats(game){this._game=game;this._div=Fz2D.createEl("div",{},this.styles);Fz2D.appendEl(this._div);this._dt=1111}Stats.prototype.update=function(timer,input){if(this._dt>1e3){this._div.innerHTML="FPS: "+timer.fps+" <br/> CTX: "+Fz2D.Renderer.supported+" <br/> DRW: "+this._game.draw_call_count+" <br/> AO: "+Fz2D.Audio.supported;return this._dt=0}else{return this._dt+=timer.dt}};return Stats}();Fz2D.Canvas=function(){Canvas.supported=function(){try{if(window.CanvasRenderingContext2D&&Fz2D.createEl("canvas").getContext("2d")){return"2d"}else{return null}}catch(_error){return null}}();Canvas.getContext=function(w,h,color,selector,type,opts){var canvas,ctx;if(color==null){color=null}if(selector==null){selector=null}if(type==null){type=this.supported}if(opts==null){opts={}}if(selector!=null){canvas=Fz2D.getEl(selector)||Fz2D.createEl("canvas")}else{canvas=Fz2D.createEl("canvas")}canvas.width=w;canvas.height=h;if(color!=null){canvas.style.backgroundColor=color}if(selector!=null){canvas.id=selector.slice(1);canvas.style.position="relative";Fz2D.appendEl(canvas)}ctx=canvas.getContext(type,opts);if(ctx!=null){ctx.mozImageSmoothingEnabled=false;ctx.webkitImageSmoothingEnabled=false;ctx.imageSmoothingEnabled=false}return ctx};Canvas.createImage=function(w,h,color){var ctx;ctx=Fz2D.Canvas.getContext(w,h);ctx.fillStyle=color;ctx.fillRect(0,0,w,h);return ctx.canvas};function Canvas(w,h,color,selector){this.w=w;this.h=h;this.color=color!=null?color:null;this.selector=selector!=null?selector:null;this._ctx=Fz2D.Renderer.getContext(this.w,this.h,this.color,this.selector);this.bounds=new Fz2D.Rect(0,0,this.w,this.h);this.draw_call_count=0}Canvas.prototype.fill=function(color){this._ctx.fillStyle=color;this._ctx.fillRect(0,0,this.w,this.h);return this._ctx};Canvas.prototype.clear=function(){this.draw_call_count=0;this._ctx.clearRect(0,0,this.w,this.h);return this._ctx};Canvas.prototype.flush=function(){};Canvas.prototype.draw=function(texture,sx,sy,sw,sh,x,y,w,h){this.draw_call_count++;this._ctx.drawImage(texture._native,sx,sy,sw,sh,x,y,w,h);return this._ctx};Canvas.prototype.toImage=function(){return this._ctx.canvas};Canvas.prototype.toElement=function(){return this._ctx.canvas};return Canvas}();Fz2D.CanvasWebGL=function(_super){__extends(CanvasWebGL,_super);CanvasWebGL.supported=function(){var canvas;try{if(window.WebGLRenderingContext){canvas=Fz2D.createEl("canvas");if(canvas.getContext("webgl")){return"webgl"}else if(canvas.getContext("experimental-webgl")){return"experimental-webgl"}else{return null}}else{return null}}catch(_error){return null}}();CanvasWebGL.VERTEX_CACHE_MAX_SIZE=24*2048;CanvasWebGL.VERTEX_SHADER="precision highp float;\n\nuniform vec2 screen;\nuniform vec2 texture;\n\nattribute vec4 pos;\nvarying vec2 texture_coord;\n\nvoid main(void)\n{ \n  texture_coord = pos.zw * texture;\n  vec2 new_pos = pos.xy * screen;\n  gl_Position = vec4(new_pos.x - 1.0, 1.0 - new_pos.y, 0.0, 1.0);\n}";CanvasWebGL.FRAGMENT_SHADER="precision highp float;\n\nuniform sampler2D texture_id;\nvarying vec2 texture_coord;\n  \nvoid main(void)\n{\n  gl_FragColor = texture2D(texture_id, texture_coord);\n}";function CanvasWebGL(){CanvasWebGL.__super__.constructor.apply(this,arguments);this.gl=this._ctx;this._texture_id=0;this.gl.enable(this.gl.BLEND);this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA);this._program=this._createShaderProgram(Fz2D.CanvasWebGL.VERTEX_SHADER,Fz2D.CanvasWebGL.FRAGMENT_SHADER);this._pos_uv_loc=this.gl.getAttribLocation(this._program,"pos");this._texture_id_loc=this.gl.getUniformLocation(this._program,"texture_id");this._texture_loc=this.gl.getUniformLocation(this._program,"texture");this._screen_loc=this.gl.getUniformLocation(this._program,"screen");this.gl.uniform1i(this._texture_id_loc,0);this.gl.uniform2f(this._screen_loc,2/this.bounds.w,2/this.bounds.h);this._buffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this._buffer);this._vertex_cache=new Float32Array(Fz2D.CanvasWebGL.VERTEX_CACHE_MAX_SIZE);this._vertex_cache_size=0;this.gl.bufferData(this.gl.ARRAY_BUFFER,this._vertex_cache,this.gl.DYNAMIC_DRAW)}CanvasWebGL.prototype.fill=function(color){var c;c=Fz2D.toRGB(color);return this.gl.clearColor(c.r,c.g,c.b,1)};CanvasWebGL.prototype.clear=function(){this.draw_call_count=0;return this.gl.clear(this.gl.COLOR_BUFFER_BIT)};CanvasWebGL.prototype.flush=function(){if(this._vertex_cache_size===0){return}this.draw_call_count++;this.gl.bufferSubData(this.gl.ARRAY_BUFFER,0,this._vertex_cache);this.gl.enableVertexAttribArray(this._pos_uv_loc);this.gl.vertexAttribPointer(this._pos_uv_loc,4,this.gl.FLOAT,false,16,0);this.gl.drawArrays(this.gl.TRIANGLES,0,this._vertex_cache_size>>2);return this._vertex_cache_size=0};CanvasWebGL.prototype.draw=function(texture,sx,sy,sw,sh,x,y,w,h){var b,r,sb,sr;if(texture._native._texture_id!==this._texture_id){this.flush();if(texture._native._texture_id){this.gl.bindTexture(this.gl.TEXTURE_2D,texture._native._texture_id)}else{texture._native._texture_id=this._createTexture(texture._native)}this._texture_id=texture._native._texture_id;this.gl.uniform2f(this._texture_loc,texture.iw,texture.ih)}r=x+w;b=y+h;sr=sx+sw;sb=sy+sh;this._vertex_cache[this._vertex_cache_size++]=x;this._vertex_cache[this._vertex_cache_size++]=y;this._vertex_cache[this._vertex_cache_size++]=sx;this._vertex_cache[this._vertex_cache_size++]=sy;this._vertex_cache[this._vertex_cache_size++]=r;this._vertex_cache[this._vertex_cache_size++]=y;this._vertex_cache[this._vertex_cache_size++]=sr;this._vertex_cache[this._vertex_cache_size++]=sy;this._vertex_cache[this._vertex_cache_size++]=x;this._vertex_cache[this._vertex_cache_size++]=b;this._vertex_cache[this._vertex_cache_size++]=sx;this._vertex_cache[this._vertex_cache_size++]=sb;this._vertex_cache[this._vertex_cache_size++]=x;this._vertex_cache[this._vertex_cache_size++]=b;this._vertex_cache[this._vertex_cache_size++]=sx;this._vertex_cache[this._vertex_cache_size++]=sb;this._vertex_cache[this._vertex_cache_size++]=r;this._vertex_cache[this._vertex_cache_size++]=y;this._vertex_cache[this._vertex_cache_size++]=sr;this._vertex_cache[this._vertex_cache_size++]=sy;this._vertex_cache[this._vertex_cache_size++]=r;this._vertex_cache[this._vertex_cache_size++]=b;this._vertex_cache[this._vertex_cache_size++]=sr;this._vertex_cache[this._vertex_cache_size++]=sb;if(this._vertex_cache_size===Fz2D.CanvasWebGL.VERTEX_CACHE_MAX_SIZE){return this.flush()}};CanvasWebGL.prototype._createShader=function(source,type){var shader;shader=this.gl.createShader(type);this.gl.shaderSource(shader,source);this.gl.compileShader(shader);if(!this.gl.getShaderParameter(shader,this.gl.COMPILE_STATUS)){console.log(this.gl.getShaderInfoLog(shader));throw"Failed to compile shader :("}return shader};CanvasWebGL.prototype._createShaderProgram=function(vertex,fragment){var fs,program,vs;program=this.gl.createProgram();vs=this._createShader(vertex,this.gl.VERTEX_SHADER);fs=this._createShader(fragment,this.gl.FRAGMENT_SHADER);this.gl.attachShader(program,vs);this.gl.attachShader(program,fs);this.gl.linkProgram(program);if(!this.gl.getProgramParameter(program,this.gl.LINK_STATUS)){console.log(this.gl.glGetProgramInfoLog(program));throw"Failed to link shader program :("}this.gl.useProgram(program);return program};CanvasWebGL.prototype._createTexture=function(image){var texture_id;texture_id=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,texture_id);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,image);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE);return texture_id};return CanvasWebGL}(Fz2D.Canvas);Fz2D.Renderer=function(Fz2D){if(Fz2D.Canvas.supported!=null){if(Fz2D.nowebgl!=null){return Fz2D.Canvas}else if(Fz2D.CanvasWebGL.supported!=null){return Fz2D.CanvasWebGL}else{return Fz2D.Canvas}}else{return null}}(Fz2D);Fz2D.Texture=function(){Texture.prototype.src=null;function Texture(image,x,y,w,h){if(image==null){image=null}if(x==null){x=0}if(y==null){y=0}if(w==null){w=null}if(h==null){h=null}if(image!=null){if(image instanceof Fz2D.Texture){this._native=image._native;if(image.texture_id!=null){this.texture_id=image.texture_id}this.x=image.x+x;this.y=image.y+y;this.w=w||image.w;this.h=h||image.h;this.iw=image.iw;this.ih=image.ih;return}else if(typeof image==="string"){w=x;x=0;h=y;y=0;image=Fz2D.Renderer.createImage(w,h,image)}this._native=image;this.x=x;this.y=y;this.w=w||image.width;this.h=h||image.height;this.iw=1/this.w;this.ih=1/this.h;return}this.x=x;this.y=y;this.w=w||0;this.h=h||0;if(this.w>0){this.iw=1/this.w}else{this.iw=0}if(this.h>0){this.ih=1/this.h}else{this.ih=0}this._native=new window.Image;this._native.onload=function(_this){return function(){console.log("Loaded image: "+_this._native.src);if(_this.w===0){_this.w=_this._native.width;_this.iw=1/_this._native.width}if(_this.h===0){_this.h=_this._native.height;_this.ih=1/_this._native.height}return _this.onload(_this)}}(this);this._native.onerror=function(_this){return function(){console.log("Failed to load image: "+_this._native.src);return _this.onload(_this)}}(this)}Texture.prototype.onload=function(texture){};Texture.prototype.load=function(path){this.src=path;this._native.src=path;return this};Texture.prototype.getSubTexture=function(x,y,w,h){var i,ww;switch(arguments.length){case 1:if(this.w%this.h===0){x=x*this.h;y=0;h=this.h;w=this.h}else{x=0;y=0;w=this.w;h=this.h}break;case 2:w=y;h=y;i=x;ww=this.w/y;x=(i%ww|0)*h;y=(i/ww|0)*h;break;default:if(x==null){x=0}if(y==null){y=0}if(h==null){h=this.h}if(w==null){if(this.w%h===0){w=h}else{w=this.w}}}return new Fz2D.Texture(this,x,y,w,h)};Texture.prototype.clone=function(){return new Fz2D.Texture(this)};Texture.prototype.toImage=function(){return this._native};return Texture}();Fz2D.TextureAtlas=function(){function TextureAtlas(texture){this.texture=texture!=null?texture:null;this.textures={}}TextureAtlas.prototype.setTexture=function(texture){return this.texture=texture};TextureAtlas.prototype.addTexture=function(tag,x,y,w,h){return this.textures[tag]=new Fz2D.Texture(this.texture,x,y,w,h)};TextureAtlas.prototype.getTexture=function(tag){return this.textures[tag]};return TextureAtlas}();Fz2D.TextureMosaic=function(_super){__extends(TextureMosaic,_super);function TextureMosaic(w,h,tw,alpha){var buffer,ctx,i,image_data,twl,x,xx,y,yy,_i,_j,_k,_l;ctx=Fz2D.Renderer.getContext(w,h,null,null,"2d");image_data=ctx.getImageData(0,0,tw,tw);buffer=image_data.data;twl=tw-1;buffer._set=function(x,y,r,g,b,a){var i;i=(x<<2)+(y<<2)*tw;buffer[i+0]=r;buffer[i+1]=g;buffer[i+2]=b;return buffer[i+3]=a};for(i=_i=0;_i<=twl;i=_i+=4){buffer[i+0]=128;buffer[i+1]=128;buffer[i+2]=128;buffer[i+3]=alpha}buffer._set(0,0,255,255,255,alpha);for(i=_j=1;1<=twl?_j<=twl:_j>=twl;i=1<=twl?++_j:--_j){buffer._set(i,0,224,224,224,alpha);buffer._set(i,1,255,255,255,alpha);buffer._set(i,twl,0,0,0,alpha);buffer._set(0,i,255,255,255,alpha);buffer._set(twl,i,0,0,0,alpha)}xx=(w/tw|0)-1;yy=(h/tw|0)-1;for(x=_k=0;0<=xx?_k<=xx:_k>=xx;x=0<=xx?++_k:--_k){for(y=_l=0;0<=yy?_l<=yy:_l>=yy;y=0<=yy?++_l:--_l){ctx.putImageData(image_data,x*tw,y*tw)}}TextureMosaic.__super__.constructor.call(this,ctx.canvas)}return TextureMosaic}(Fz2D.Texture);Fz2D.Animation=function(){function Animation(tag,texture,count,delay){var i,w,_i,_ref;this.tag=tag;this.texture=texture;this.count=count;this.delay=delay;this.ended=true;if(this.count==null||this.count<1){if(this.texture.w%this.texture.h===0){this.count=this.texture.w/this.texture.h}else{this.count=1}}if(this.delay==null){this.delay=1e3/this.count}w=this.texture.w/this.count;this.frames=[];for(i=_i=0,_ref=this.count-1;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i){this.frames.push(new Fz2D.Rect(this.texture.x+i*w,this.texture.y,w,this.texture.h))}this.frame=this.frames[0];this._index=0;this._dt=0;this._loop=false;if(this.count===1){this.play=function(_this){return function(){return _this}}(this)}}Animation.prototype.onend=function(animation){};Animation.prototype.play=function(looped){this.ended=false;this.frame=this.frames[0];this._index=0;this._dt=0;this._loop=looped||false;return this};Animation.prototype.stop=function(){this.ended=true;return this};Animation.prototype.update=function(timer,input){if(this.ended){return null}this._dt+=timer.dt;if(this._dt<this.delay){return null}this.frame=this.frames[this._index];if(++this._index===this.count){if(this._loop){this._index=0}else{--this._index}if(this.ended=this._index>0){this.onend(this)}}this._dt=0;return null};return Animation}();Fz2D.BBox=function(){function BBox(x,y,w,h){this.x=x!=null?x:0;this.y=y!=null?y:0;this.w=w!=null?w:0;this.h=h!=null?h:0;this._update()}BBox.prototype.set=function(x,y,w,h){this.x=x;this.y=y;this.w=w;this.h=h;return this._update()};BBox.prototype.setPos=function(x,y){this.x=x;this.y=y;return this};BBox.prototype.setSize=function(w,h){this.w=w;this.h=h;return this._update()};BBox.prototype.contains=function(p){return this.p.x>=this.x&&this.p.x<=this.x+this.w&&this.p.y>=this.y&&this.p.y<=this.y+this.h};BBox.prototype.overlaps=function(r){return!(this.x>r.x+r.w||this.y>r.y+r.h||this.x+this.w<r.x||this.y+this.h<r.y)};BBox.prototype.equals=function(r){return this.x===r.x&&this.y===r.y&&this.w===r.w&&this.h===r.h};BBox.prototype.isNull=function(){return this.w===0||this.h===0};BBox.prototype._update=function(){this.hw=this.w/2;this.hh=this.h/2;this.cx=this.x+this.hw;this.cy=this.y+this.hh;return this};return BBox}();Fz2D.Font=function(){function Font(texture,size,s,e){var c,end,i,start,w,x,xx,y,yy,_i;this.texture=texture;this.size=size!=null?size:this.texture.h;if(s==null){s=" "}if(e==null){e="~"}this.chars={};start=(s||" ").charCodeAt(0);end=(e||"~").charCodeAt(0)+1;w=this.texture.w/this.size;for(c=_i=start;start<=end?_i<=end:_i>=end;c=start<=end?++_i:--_i){i=c-start;xx=i%w;yy=(i-xx)/w;x=this.texture.x+xx*this.size;y=this.texture.y+yy*this.size;this.chars[String.fromCharCode(c)]=new Fz2D.Rect(x,y,this.size,this.size)}this.invalid_char=this.chars[String.fromCharCode(end)]}Font.prototype.centerText=function(ro,text,size,line_spacing,word_spacing){var m;if(size==null){size=this.size}if(line_spacing==null){line_spacing=size+size}if(word_spacing==null){word_spacing=size}m=this.measureText(text,size,line_spacing,word_spacing);return new Fz2D.Rect(ro.x+(ro.w-m.w>>1),ro.y+(ro.h-m.h>>1),ro.w,ro.h)};Font.prototype.measureText=function(text,size,line_spacing,word_spacing){var c,h,maxWidth,w,_i,_len;if(size==null){size=this.size}if(line_spacing==null){line_spacing=size+size}if(word_spacing==null){word_spacing=size}w=0;h=0;maxWidth=0;for(_i=0,_len=text.length;_i<_len;_i++){c=text[_i];switch(c){case" ":w+=word_spacing;continue;case"\n":if(w>maxWidth){maxWidth=w}w=0;h+=line_spacing;continue;case"	":w+=3*word_spacing;continue}w+=size}if(w>0&&maxWidth===0){maxWidth=w}if(maxWidth>0&&h===0){h=size}return new Fz2D.Rect(0,0,maxWidth,h)};Font.prototype.drawText=function(ctx,text,x,y,size,line_spacing,word_spacing){var c,char,xx,yy,_i,_len;if(size==null){size=this.size}if(line_spacing==null){line_spacing=size+size
}if(word_spacing==null){word_spacing=size}xx=x;yy=y;for(_i=0,_len=text.length;_i<_len;_i++){c=text[_i];switch(c){case" ":xx+=word_spacing;continue;case"\n":xx=x;yy+=line_spacing;continue;case"	":xx+=3*word_spacing;continue}char=this.chars[c]||this.invalid_char;ctx.draw(this.texture,char.x,char.y,char.w,char.h,xx,yy,size,size);xx+=size}return xx};return Font}();Fz2D.Object=function(){function Object(x,y,w,h,tag){this.x=x;this.y=y;this.w=w;this.h=h;this.tag=tag!=null?tag:"object";this.bounds=new Fz2D.BBox(0,0,this.w,this.h);this.solid=true;this.visible=true;this.alive=true;this.exists=true}Object.prototype.kill=function(){this.visible=false;this.alive=false;this.exists=false;return this};Object.prototype.killAll=function(){return this.kill()};Object.prototype.reset=function(x,y){if(x==null){x=null}if(y==null){y=null}if(x!=null){this.x=x}if(y!=null){this.y=y}this.visible=true;this.alive=true;this.exists=true;return this};Object.prototype.resetAll=function(){return this.reset()};Object.prototype.draw=function(ctx){};Object.prototype.update=function(timer,input){};return Object}();Fz2D.Entity=function(_super){__extends(Entity,_super);function Entity(texture,x,y,w,h,tag){this.texture=texture;if(x==null){x=0}if(y==null){y=0}if(w==null){w=null}if(h==null){h=null}if(tag==null){tag=null}if(h==null){h=this.texture.h}if(w==null){if(this.texture.w%h===0){w=h}else{w=this.texture.w}}Entity.__super__.constructor.call(this,x,y,w,h,tag);this.dx=0;this.dy=0;this.moving=false;this.animations={};this.addAnimation("_default",this.texture);this.play("_default",true)}Entity.prototype.clone=function(){return new Fz2D.Entity(this.texture,this.x,this.y,this.w,this.h,this.tag)};Entity.prototype.play=function(tag,looped){this.animation=this.animations[tag];this.animation.play(looped);return this.animation};Entity.prototype.stop=function(){this.animation.stop();return this.animation};Entity.prototype.is=function(tag){return this.animation.tag===tag};Entity.prototype.addAnimation=function(tag,texture,count,delay){return this.animations[tag]=new Fz2D.Animation(tag,texture,count,delay)};Entity.prototype.draw=function(ctx){ctx.draw(this.animation.texture,this.animation.frame.x,this.animation.frame.y,this.animation.frame.w,this.animation.frame.h,this.x,this.y,this.w,this.h);return null};Entity.prototype.update=function(timer,input){if(!this.animation.ended){this.animation.update(timer)}if(this.moving){this.x+=this.dx*timer.dt;this.y+=this.dy*timer.dt}return null};return Entity}(Fz2D.Object);Fz2D.Group=function(_super){__extends(Group,_super);function Group(x,y,w,h){if(x==null){x=0}if(y==null){y=0}if(w==null){w=0}if(h==null){h=0}Group.__super__.constructor.call(this,x,y,w,h);this._objects=[]}Group.prototype.recycle=function(){var o,_i,_len,_ref;_ref=this._objects;for(_i=0,_len=_ref.length;_i<_len;_i++){o=_ref[_i];if(!o.exists){return o}}return null};Group.prototype.recycleByTag=function(tag){var o,_i,_len,_ref;_ref=this._objects;for(_i=0,_len=_ref.length;_i<_len;_i++){o=_ref[_i];if(!o.exists&&o.tag===tag){return o}}};Group.prototype.recycleByClass=function(klass){var o,_i,_len,_ref;_ref=this._objects;for(_i=0,_len=_ref.length;_i<_len;_i++){o=_ref[_i];if(!o.exists&&o instanceof klass){return o}}};Group.prototype.hasAlive=function(){return this.firstAlive()!=null};Group.prototype.hasAliveByTag=function(tag){return this.firstAliveByTag(tag)!=null};Group.prototype.hasAliveByClass=function(klass){return this.firstAliveByClass(klass)!=null};Group.prototype.firstAvail=function(){var o,_i,_len,_ref;_ref=this._objects;for(_i=0,_len=_ref.length;_i<_len;_i++){o=_ref[_i];if(!o.exists){return o}}return null};Group.prototype.firstAvailByTag=function(tag){var o,_i,_len,_ref;_ref=this._objects;for(_i=0,_len=_ref.length;_i<_len;_i++){o=_ref[_i];if(!o.exists&&o.tag===tag){return o}}return null};Group.prototype.firstAvailByClass=function(klass){var o,_i,_len,_ref;_ref=this._objects;for(_i=0,_len=_ref.length;_i<_len;_i++){o=_ref[_i];if(!o.exists&&o instanceof klass){return o}}return null};Group.prototype.firstExisting=function(){var o,_i,_len,_ref;_ref=this._objects;for(_i=0,_len=_ref.length;_i<_len;_i++){o=_ref[_i];if(o.exists){return o}}return null};Group.prototype.firstExistingByTag=function(tag){var o,_i,_len,_ref;_ref=this._objects;for(_i=0,_len=_ref.length;_i<_len;_i++){o=_ref[_i];if(o.exists&&o.tag===tag){return o}}return null};Group.prototype.firstExistingByClass=function(klass){var o,_i,_len,_ref;_ref=this._objects;for(_i=0,_len=_ref.length;_i<_len;_i++){o=_ref[_i];if(o.exists&&o instanceof klass){return o}}return null};Group.prototype.firstAlive=function(){var o,_i,_len,_ref;_ref=this._objects;for(_i=0,_len=_ref.length;_i<_len;_i++){o=_ref[_i];if(o.alive){return o}}return null};Group.prototype.firstAliveByTag=function(tag){var o,_i,_len,_ref;_ref=this._objects;for(_i=0,_len=_ref.length;_i<_len;_i++){o=_ref[_i];if(o.alive&&o.tag===tag){return o}}return null};Group.prototype.firstAliveByClass=function(klass){var o,_i,_len,_ref;_ref=this._objects;for(_i=0,_len=_ref.length;_i<_len;_i++){o=_ref[_i];if(o.alive&&o instanceof klass){return o}}return null};Group.prototype.firstDead=function(){var o,_i,_len,_ref;_ref=this._objects;for(_i=0,_len=_ref.length;_i<_len;_i++){o=_ref[_i];if(!o.alive){return o}}return null};Group.prototype.firstDeadByTag=function(tag){var o,_i,_len,_ref;_ref=this._objects;for(_i=0,_len=_ref.length;_i<_len;_i++){o=_ref[_i];if(!o.alive&&o.tag===tag){return o}}return null};Group.prototype.firstDeadByTag=function(klass){var o,_i,_len,_ref;_ref=this._objects;for(_i=0,_len=_ref.length;_i<_len;_i++){o=_ref[_i];if(!o.alive&&o instanceof klass){return o}}return null};Group.prototype.add=function(object){this._objects.push(object);if(object.group==null){object.group=this}return object};Group.prototype.remove=function(object){return this.removeByIndex(this._objects.indexOf(object))};Group.prototype.removeByIndex=function(i){var arr,object;if(i>-1){arr=this._objects.splice(i,1);if(arr.length===1){object=arr[0];if(object.group===this){object.group=null}return object}else{return null}}else{return null}};Group.prototype.removeByTag=function(tag){var o,_i,_len,_ref;_ref=this._objects;for(_i=0,_len=_ref.length;_i<_len;_i++){o=_ref[_i];if(o.tag===tag){return this.remove(o)}}return null};Group.prototype.removeByClass=function(klass){var o,_i,_len,_ref;_ref=this._objects;for(_i=0,_len=_ref.length;_i<_len;_i++){o=_ref[_i];if(o instanceof klass){return this.remove(o)}}return null};Group.prototype.killAll=function(){var o,_i,_len,_ref;_ref=this._objects;for(_i=0,_len=_ref.length;_i<_len;_i++){o=_ref[_i];o.killAll()}return null};Group.prototype.resetAll=function(){var o,_i,_len,_ref;_ref=this._objects;for(_i=0,_len=_ref.length;_i<_len;_i++){o=_ref[_i];o.resetAll()}return null};Group.prototype.findByTag=function(tag){var o,_i,_len,_ref;_ref=this._objects;for(_i=0,_len=_ref.length;_i<_len;_i++){o=_ref[_i];if(o.tag===tag){return o}}return null};Group.prototype.findByClass=function(klass){var o,_i,_len,_ref;_ref=this._objects;for(_i=0,_len=_ref.length;_i<_len;_i++){o=_ref[_i];if(o instanceof klass){return o}}return null};Group.prototype.first=function(){return this._objects[0]};Group.prototype.last=function(){return this._objects[this._objects.length-1]};Group.prototype.at=function(i){return this._objects[i]};Group.prototype.clear=function(){return this._objects=[]};Group.prototype.length=function(){return this._objects.length};Group.prototype.draw=function(ctx){var o,_i,_len,_ref;_ref=this._objects;for(_i=0,_len=_ref.length;_i<_len;_i++){o=_ref[_i];if(o.exists&&o.visible){o.draw(ctx)}}return null};Group.prototype.update=function(timer,input){var o,_i,_len,_ref;_ref=this._objects;for(_i=0,_len=_ref.length;_i<_len;_i++){o=_ref[_i];if(o.exists&&o.alive){o.update(timer,input)}}return null};return Group}(Fz2D.Object);Fz2D.Gui.Button=function(_super){__extends(Button,_super);function Button(x,y,text,font,size,texture_up,texture_down,texture_over){this.font=font;this.size=size!=null?size:this.font.size;if(texture_down==null){texture_down=texture_up}if(texture_over==null){texture_over=texture_down}Button.__super__.constructor.call(this,texture_up,x,y);this.addAnimation("up",texture_up);this.addAnimation("down",texture_down);this.addAnimation("over",texture_over);this.label=new Fz2D.Gui.Label("",x,y,this.font,this.size);this.setText(text)}Button.prototype.setText=function(text){var c;c=this.font.centerText(this,text,this.size);this.label.setText(text);this.label.x=c.x;this.label.y=c.y;this.text=text;return this};Button.prototype.onclick=function(button){};Button.prototype.draw=function(ctx){Button.__super__.draw.apply(this,arguments);if(this.is("down")){this.label.y++;this.label.draw(ctx);this.label.y--}else{this.label.draw(ctx)}return null};Button.prototype.update=function(timer,input){if(Fz2D.contains(this,input.mouse.position)){if(input.mouse[Fz2D.Input.Mouse.Button.LEFT]){this.play("down")}else{this.play("over")}if(input.mouse.released[Fz2D.Input.Mouse.Button.LEFT]){this.onclick(this)}}else if(!this.is("up")){this.play("up")}return null};return Button}(Fz2D.Entity);Fz2D.Gui.Countdown=function(_super){__extends(Countdown,_super);function Countdown(count,x,y,font,size){this.count=count;this.font=font;this.size=size!=null?size:this.font.size;Countdown.__super__.constructor.call(this,x,y);if(this.count==null){this.count=0}this._count=0;this._dt=0;this.ended=true}Countdown.prototype.onend=function(countdown){};Countdown.prototype.reset=function(){Countdown.__super__.reset.apply(this,arguments);this.ended=false;this._dt=0;return this._count=this.count};Countdown.prototype.draw=function(ctx){this.font.drawText(ctx,this._count.toString(),this.x,this.y,this.size);return null};Countdown.prototype.update=function(timer,input){if(this.ended){return null}this._dt+=timer.dt;if(this._dt>1e3){this._dt=0;if(this._count===0){this.ended=true;this.onend(this)}else{this._count--}}return null};return Countdown}(Fz2D.Object);Fz2D.Gui.Label=function(_super){__extends(Label,_super);function Label(text,x,y,font,size){this.font=font;this.size=size!=null?size:this.font.size;Label.__super__.constructor.call(this,x,y);this.setText(text);this.blink=0;this._dt=0}Label.prototype.setText=function(text){var size;this.text=text;size=this.font.measureText(text,this.size);this.bounds.w=this.w=size.w;this.bounds.h=this.h=size.h;return this};Label.prototype.inc=function(amount){if(amount==null){amount=1}return this.setText((this.toInt()+amount).toString())};Label.prototype.dec=function(amount){if(amount==null){amount=1}return this.inc(-amount)};Label.prototype.toInt=function(){return parseInt(this.text)};Label.prototype.draw=function(ctx){return this.font.drawText(ctx,this.text,this.x,this.y,this.size)};Label.prototype.update=function(timer,input){if(!(this.blink>0)){return}this._dt+=timer.dt;if(!(this._dt>this.blink)){return}this._dt=0;return this.visible=!this.visible};return Label}(Fz2D.Object);Fz2D.Gui.Mouse=function(_super){__extends(Mouse,_super);function Mouse(){return Mouse.__super__.constructor.apply(this,arguments)}Mouse.prototype.update=function(timer,input){this.x=input.mouse.x;return this.y=input.mouse.y};return Mouse}(Fz2D.Entity);Fz2D.HorizontalScroller=function(_super){__extends(HorizontalScroller,_super);function HorizontalScroller(){HorizontalScroller.__super__.constructor.apply(this,arguments);this.dx=-.3;this.sx=this.w;this.wf=this.w*1}HorizontalScroller.prototype.draw=function(ctx){ctx.draw(this.texture,this.w-this.sx,this.y,this.sx,this.h,this.x,this.y,this.sx,this.h);return ctx.draw(this.texture,this.x,this.y,this.w-this.sx,this.h,this.sx,this.y,this.w-this.sx,this.h)};HorizontalScroller.prototype.update=function(timer,input){if(this.sx<=0){return this.sx=this.w}else{return this.sx=Fz2D.clamp(this.sx+timer.dt*this.dx,0,this.wf)}};return HorizontalScroller}(Fz2D.Entity);Fz2D.VerticalScroller=function(_super){__extends(VerticalScroller,_super);function VerticalScroller(){VerticalScroller.__super__.constructor.apply(this,arguments);this.dy=.3;this.sy=0;this.hf=this.h*1}VerticalScroller.prototype.draw=function(ctx){ctx.draw(this.texture,this.x,this.h-this.sy,this.w,this.sy,this.x,this.y,this.w,this.sy);return ctx.draw(this.texture,this.x,this.y,this.w,this.h-this.sy,this.x,this.sy,this.w,this.h-this.sy)};VerticalScroller.prototype.update=function(timer,input){if(this.sy>=this.h){return this.sy=0}else{return this.sy=Fz2D.clamp(this.sy+timer.dt*this.dy,0,this.hf)}};return VerticalScroller}(Fz2D.Entity);Fz2D.Point=function(){function Point(x,y){this.x=x!=null?x:0;this.y=y!=null?y:0}Point.prototype.set=function(x,y){this.x=x;return this.y=y};Point.prototype.equals=function(p){return this.x===p.x&&this.y===p.y};Point.prototype.isNull=function(){return this.x===0&&this.y===0};return Point}();Fz2D.Rect=function(){function Rect(x,y,w,h){this.x=x!=null?x:0;this.y=y!=null?y:0;this.w=w!=null?w:0;this.h=h!=null?h:0}Rect.prototype.set=function(x,y,w,h){this.x=x;this.y=y;this.w=w;this.h=h;return this};Rect.prototype.setPos=function(x,y){this.x=x;this.y=y;return this};Rect.prototype.setSize=function(w,h){this.w=w;this.h=h;return this};Rect.prototype.contains=function(p){return this.p.x>=this.x&&this.p.x<=this.x+this.w&&this.p.y>=this.y&&this.p.y<=this.y+this.h};Rect.prototype.overlaps=function(r){return!(this.x>r.x+r.w||this.y>r.y+r.h||this.x+this.w<r.x||this.y+this.h<r.y)};Rect.prototype.equals=function(r){return this.x===r.x&&this.y===r.y&&this.w===r.w&&this.h===r.h};Rect.prototype.isNull=function(){return this.w===0||this.h===0};return Rect}();Fz2D.Size=function(){function Size(w,h){this.w=w!=null?w:0;this.h=h!=null?h:0}Size.prototype.set=function(w,y){this.w=w;return this.h=y};Size.prototype.equals=function(p){return this.w===p.w&&this.h===p.y};Size.prototype.isNull=function(){return this.w===0&&this.h===0};return Size}();Fz2D.Audio=function(){Audio.extension=function(audio){if(audio.canPlayType("audio/ogg")){return"ogg"}else if(audio.canPlayType("audio/mp3")){return"mp3"}else{console.log("No support for audio :(");return null}}(new window.Audio);Audio.supported=function(){if(Fz2D.noaudio!=null){console.log("Audio support has been disabled :(");return null}else{return Audio.extension}}();Audio.prototype.src=null;function Audio(audio){if(audio==null){audio=null}if(audio instanceof Fz2D.Audio){this._native=audio._native.cloneNode(true)}else{this._native=new window.Audio;this._native.loop=false;this._native.preload=true;this._native.addEventListener("loadedmetadata",function(_this){return function(){console.log("Loaded audio: "+_this._native.src);return _this.onload(_this)}}(this));this._native.onerror=function(_this){return function(){console.log("Failed to load audio: "+_this._native.src);return _this.onload(_this)}}(this)}}Audio.prototype.onload=function(audio){};Audio.prototype.load=function(path){this.src=path;this._native.src=path;return this};Audio.prototype.play=function(looped){this._native.loop=looped||false;this._native.play();return this};Audio.prototype.pause=function(){this._native.pause();return this};Audio.prototype.stop=function(){this._native.pause();this._native.currentTime=0;return this};Audio.prototype.setLoop=function(state){this._native.loop=state;return this};Audio.prototype.setVolume=function(volume){this._native.volume=parseFloat(Fz2D.clamp(volume,0,100)/100);return this};Audio.prototype.clone=function(){return new Fz2D.Audio(this)};Audio.prototype.toAudio=function(){return this._native};return Audio}();Fz2D.Game=function(){Game.run=function(opts){if(opts==null){opts={}}return this.instance!=null?this.instance:this.instance=new this(opts)};function Game(opts){var instance,k,plugin,v,_i,_len,_ref;if(opts==null){opts={}}this._loop=__bind(this._loop,this);for(k in opts){v=opts[k];this[k]=v}if(this.bg==null){this.bg=Fz2D.BG}if(this.fg==null){this.fg=Fz2D.FG}if(this.selector==null){this.selector=Fz2D.SELECTOR}if(this.path==null){this.path=Fz2D.PATH}if(!(this.w!=null&&this.h!=null)){throw"Game has invalid width and/or height :("}if(Fz2D.Renderer==null){throw"Canvas is not supported by your browser :("}this.storage=new Fz2D.Storage;this._plugins=[];if(this.plugins!=null){_ref=this.plugins;for(_i=0,_len=_ref.length;_i<_len;_i++){plugin=_ref[_i];if(plugin.supported==null){continue}instance=new plugin(this);if(typeof instance.update==="function"){this._plugins.push(instance)}}}this._timer=new Fz2D.Timer;this._ctx=new Fz2D.Renderer(this.w,this.h,this.bg,this.selector);this.input=new Fz2D.Input(this._ctx.toElement());this.scene=new Fz2D.Group(0,0,this.w,this.h);this.draw_call_count=0;this._loader=new Fz2D.Loader(this);this._loader.onload=function(_this){return function(){_this.update(_this._timer,_this._input);_this.draw(_this._ctx);_this.scene.remove(_this._loader);return _this.onload(_this)}}(this);this._loop();if(this.assets!=null){this.scene.add(this._loader);this._loadAssets(this.assets)}else{this.onload(this)}}Game.prototype.onload=function(game){};Game.prototype.load=function(path){if(this._loader.group==null){this.scene.add(this._loader)}return this._loader.load(path)};Game.prototype.draw=function(ctx){return this.scene.draw(ctx)};Game.prototype.update=function(timer,input){return this.scene.update(timer,input)};Game.prototype._loadAssets=function(assets){var k,url,_results;_results=[];for(k in assets){url=assets[k];if(typeof url==="object"){_results.push(this._loadAssets(url))}else{_results.push(assets[k]=this._loader.load(url))}}return _results};Game.prototype._loop=function(){var plugin,_i,_len,_ref;_ref=this._plugins;for(_i=0,_len=_ref.length;_i<_len;_i++){plugin=_ref[_i];plugin.update(this._timer,this.input)}this.update(this._timer,this.input);this.draw_call_count=this._ctx.draw_call_count;this._ctx.clear();this.draw(this._ctx);this._ctx.flush();this.input.update();this._timer.update();return requestAnimationFrame(this._loop)};return Game}();Fz2D.Storage=function(){function Storage(){}Storage.prototype.get=function(name,value){if(value==null){value=0}return JSON.parse(localStorage.getItem(name)||value)};Storage.prototype.set=function(name,value){return localStorage.setItem(name,JSON.stringify(value))};Storage.prototype.remove=function(name){return localStorage.removeItem(name)};return Storage}();Fz2D.Timer=function(){function Timer(){this._start=new Date;this._last=new Date;this._prev=new Date;this._frames=0;this.fps=0;this.dt=0;this.ticks=0}Timer.prototype.update=function(){var now;now=new Date;this._frames++;if(now-this._prev>1e3){this._prev=now;this.fps=this._frames;this._frames=0}this.dt=now-this._last;this.ticks=now-this._start;return this._last=now};return Timer}();